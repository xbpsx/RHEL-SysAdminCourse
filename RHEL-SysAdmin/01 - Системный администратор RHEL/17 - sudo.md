Если говорить кратко, `sudo` запускает команды от имени какого-то пользотеля. А в файле `/etc/sudoers` пишуться те самые политики.

```bash
# /etc/sudoers
root ALL=(ALL:ALL) ALL
```

Что означают **ALL** 

1) **ALL** - это значит на каком ПК, если первое значение ALL или совпдает с именем ПК, которйы можно проверить с помощью, то `sudo` будет работать с этой строчкой. Если тут написано, что=то другое, то его проигнарируют. 

```bash
hostname
debian
```

2) **ALL** - от имени пользователя. ALL значит от всех, значит можно запустить команду от всех пользователей. По умолчанию, если явно не указано, то команда запуститься от имени `root` . А так, тут можно написать имя, конкретного пользователя, допустим

```bash
# etc/sudoers
root ALL=(user2:ALL) ALL
```

В таком случае пользователь `root` сможет запускать команду `sudo` только от имени **user2**. Так же рядом, можно указать группу или просто группу

```bash
# /etc/sudoers
root ALL=(user2:group) ALL
root ALL=(group) ALL
```

3) **ALL** - это команды, в случае **ALL** можнно запустить любую команду, а так тут можно прописать те команды, которые мы хотим разрешить  или наооборот запретить, перед запрещеной командой, нужно указать `!`

```bash
# etc/sudoers
root ALL=(ALL:ALL) /bin/ls, !/bin/mkdir
```

Первое это пользователь, для кого написана политика. Если начинается со знака `%` то речь идет о группе пользователей. Например:

```bash
# /etc/sudoers
%wheel ALL=(ALL) ALL
```

Так вот,  почему наш пользователь **user** может запускать команды с помощью `sudo` 

Пока, что в файле `/etc/sudoers` всего 2 политки

```bash
# etc/sudoers
root ALL=(ALL:ALL) ALL # для пользователя root
%wheel ALL=(ALL) ALL   # для группы wheel (куда мы добавляем себя)
```

Что бы узнать в каких группах состоит наш пользователь, есть утилиа `groups`

```bash
xbpsx@debian:~$ groups
xbpsx cdrom floppy sudo audio dip video plugdev users netdev scanner bluetooth lpadmin libvirt kvm
```

Либо можно узнать где **состоит другой пользователь** 

```bash
groups user2
```

---
## Частые случаи использования sudo

Если выполнить  просто команду `su` то мы меняем , текующего пользователя на `root`.  Команда `sudo` позволяет нам выполнить команду **от имени суперпрользователя**.  Если выполнить команду `su` от суперпользователя, то пароль нам указывать не нужно. А значит выпролнив и введя пароль своего пользователя:

```bash
sudo su
```

Мы просто от имени суперпользвоателя запустим команду `su`  и станем суперпользователем. **Таким образом не зная пароль суперпользователя мы можем стать root**.

```bash
xbpsx@debian:~$ sudo su
[sudo] password for xbpsx: 
root@debian:/home/xbpsx# 
```

> Учитывая, что `sudo` механизм, что-бы повысить свои привилегии, этим активно пользуются злоумышленники.

**Давайте в теории расмотрим один из случаев** с помощью переменной `$PATH`

Мы видим директорию:

```bash
echo $PATH
/home/user1/.local/bin
```

Сейчас этой директории нет, но мы можем ее создать:

```bash
mkdir ~/.local/bin
```

И сделать обманку,  **создадим символическую ссылку** на `su`

```bash
ln -s /bin/su ~/.local/bin/htop
```

Теперь когда мы пишем `htop` **bash** смотрит переменную  `$PATH` видит вначале `.local/bin` находим там программу `htop` и запускает. **На самом деле это программа su**. Но это слишком примитивно и везде есть защита от этого. 

Что-бы найти **полный путь утилиты** `which` 

```bash
xbpsx@debian:~ which htop
/usr/bin/htop
```

Если мы ограничиваем пользователя, то нужно быть предельно аккуратным. Очень часто **можно повысить привилегии**, не очевидным способом. 

Например, давая кому-то **право создать пользователя**, он может создать пользователя с группой `%wheel` и черз него стать `root` 

```bash
sudo useradd user3 -g wheel
```

Поэтому прежде чем давать пользователю привлегии надо командой, нужно **внимательно почитать, что это программа может сделать**

```bash
sudo less /etc/passwd
```

Например тот же `less` или `vi` позволяют запускать команды. И для них есть **специальный ключа** что бы предотвратить выполнение сторонних команд `NOEXEC`

```bash
/etc/sudoers
user2 ALL=(ALL:ALL) NOEXEC: /user/bin/less
```

Есть еще пару ключей, один из интересных `NOPASSWD`, позволяет запускать команды без ввода пароля. 

```bash
/etc/sudoers
user2 ALL=(ALL:ALL) NOEXEC: /user/bin/less
user2 ALL=(ALL:ALL) NOPASSWD: /usr/bin/nano
```

Так же, чтоб постоянно не вводить `sudo`.  Можно предварительно написать:

```bash
sudo -s
```

Так же в некоторых случаев люди используют `sudo` что бы предоставить доступ к **редактированию** файлов. Лучше использовать права на файл, но ситуации бывают разные. У `sudo` есть относительно безопасный способ редактирования файлов с помощью `sudoedit`

```bash
/etc/sudoers
user2 ALL=(ALL:ALL) NOPASSWD: sudoedit /etc/passwd
```

> `sudoedit` копирует нужный мне файл во временный файл, я редактирую временный файл, а когда сохроняем `sudoedit` заменяет нужный мне файл той копией которую я изменил. 

 Когда у нас много пользователей, много ПК и команд. Для облегченифя прописывани политик, можно использовать `alias`, где можно перечислить несколько значений через запятую. в файле `/etc/sudoers` есть примеры использования.

```bash
/etc/sudoers
# User_Alias ADMINS = jsmith, miken
```

Политика состоит из 4 столбиков:

![[Screenshot From 2025-12-17 15-17-43.png]]

- **user** - пользователь или группа, к которой применяется политика, поэтому `alias` называется **User Alias**
- **host** - **Host Alias**
- **Runas_Alias** - дальше у нас столбик где указывается, от чего имени разрешает запускать
- **cmnd_Alias** -команды

```bash
Host_Alias FILESERVERS = fs1, f2
Host_Alias MAILSERVERS = smtp, smtp2
Runas_Alias TEST = user2
Cmnd_Alias PROCESSES = /bin/nice, bin/kill, /usr/bin/kill, /usr/bin/killall`
```

И тут пример политик с **алиасами** 

```bash
%sys ALL = NETWORKING, SOFTWARE, SERVICES, STORAGE, DELEGATING, PROCESSES, LOCATE, DRIVERS
```

Так же бывает полезно узнать, **кто какие команды вводил с помощью** `sudo`. Все действия `sudo` логирует 

```bash
# RHEL
xbpsx@debian:~$ sudo grep sudo /var/log/secure
# Debian 
sudo journalctl | grep sudo
```

Так же в плане логирования, у `sudo` е сть инструмент `sudoreplay`

```bash
sudo sudoreplay
```

В самом конце настройки файла, говорит нам, что `sudoers` будет читать настройки из всех файлов находящийся внутри директории `/etc/sudoers.d`

```bash
#includedir /etc/sudoers.d
```

Для этого нам нужно указать 

```bash
sudo visudo -f /etc/sudoers.d/test

#test
user2 centos8=(root) PASSWD /usr/bin/passwd !/usr/bin/passwd root
```

Пользователь **user2** на хосте **cventos8** от имени **root** может запускать **PASSWD** 

**/usr/bin/passwd** - он может меня ть пароли другим пользователям
**!/usr/bin/passwd root** - запрет на смену пароля суперпользователю

**user2** может запускать команды от имени пользователя **user** комануду `ls`
```bash
# etc/sudoers.d/test
user2 centos8=(user) /bin/ls
```

`sudo` инструмент который позволяет дать опредленным пользователям, определенные права, но это делает `sudo` **очень опасным** инструментом, который активно используется злоумышленниками.

> Без острой необходимости, пользователей в `sudo` прописывать не стоит. Давать доступ только на необходимые команды. В дальнейшем лучше писать скрипты. 


