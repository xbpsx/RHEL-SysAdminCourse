## **OOM (Out of Memory) — ситуация исчерпания памяти**

### **Что это?**

Это **критическое состояние системы**, когда:

1. **Вся оперативная память (RAM) исчерпана.**

2. **Swap-раздел (если есть) тоже заполнен до предела.**

3. **Система физически не может выделить память для новых запросов.**

На этом моменте обычные механизмы ядра уже не работают — система **полностью зависает**.

---
### **Что происходит "под капотом"?**

1. **Попытка освободить кэш:** Ядро сначала пытается освободить кэшированные данные (чистые страницы), но это часто не помогает, так как память уже "съедена" резидентной памятью процессов (RES).

2. **Активация OOM-killer:** Когда дальше некуда, запускается механизм **OOM-killer** — "убийца процессов".

3. **Выбор "жертвы":** OOM-killer не убивает процессы случайно. Он использует сложный алгоритм, который оценивает:

    - **Потребление памяти** процессом (чем больше — тем выше шанс)
    
    - **"Ценность" процесса:**
        
        - Дочерние процессы чаще убиваются раньше родительских
        
        - Процессы, работающие долго, имеют больший "вес" (их жалко убивать)
        
        - Процессы root-пользователя имеют больший вес
    
        - Процессы, выполняющие важные системные функции, имеют бонус к выживанию
    
    - **Пользовательские настройки:** Можно задать "оценку" (`oom_score_adj`) от -1000 (никогда не убивать) до +1000 (убивать первым)
        

### **Последствия OOM:**

- **Полный hang (зависание)** системы — не реагирует даже на мышь/клавиатуру

- **Потеря данных** в приложениях

- **Некорректное завершение** критичных служб

- **В худшем случае** — только hard reboot (выдернуть шнур)


---
### **Примеры принудительных мер:**

#### **1. Магическая клавиша SysRq**

Клавиша **SysRq** (часто совмещена с **Print Screen**) — это "черный ход" в ядро Linux, который работает **даже когда система полностью зависла** (если не отключено в настройках ядра).

**Как работает:** Комбинации `Alt+SysRq+[буква]` отправляют команды напрямую ядру, минуя все слои системы.

#### **2. Комбинация для борьбы с OOM: `Alt+SysRq+F`**

- **Что делает:** Принудительно вызывает **OOM-killer**, чтобы убить процесс-пожиратель памяти.

- **Как работает:** Ядро немедленно запускает алгоритм выбора "жертвы" и убивает процесс с максимальным `oom_score`.

- **Важно:** Это не гарантирует спасение системы, но часто помогает.

---
## **Практическое руководство для администратора**

### **Памятка по SysRq (полезно распечатать!)**

**Запомните мнемонику:** **R**eboot **E**ven **I**f **S**ystem **U**tterly **B**roken → **REISUB**

Это безопасная последовательность перезагрузки при полном зависании:

```text
# Выполнять с паузой в 1-2 секунды между командами:

Alt+SysRq+R  # Переключить клавиатуру из Raw mode (вернёт управление)
Alt+SysRq+E  # Отправить SIGTERM всем процессам (мягкое завершение)
Alt+SysRq+I  # Отправить SIGKILL всем процессам (принудительное завершение)
Alt+SysRq+S  # Синхронизировать диски (сбросить кэши на диск)
Alt+SysRq+U  # Перемонтировать все ФС в read-only
Alt+SysRq+B  # Перезагрузить систему
```

### **Другие полезные комбинации SysRq:**

- **`Alt+SysRq+T`** — показать список всех процессов (вывод в syslog)

- **`Alt+SysRq+M`** — вывести информацию о памяти (в syslog)

- **`Alt+SysRq+W`** — показать процессы в uninterruptible sleep (D-состояние)

- **`Alt+SysRq+L`** — показать backtrace всех активных процессоров

---
## **Как предотвратить OOM и что делать администратору**

### **Профилактика (до того, как случилось):**

1. **Мониторинг:**

```bash
# Установите утилиты
apt install atop htop earlyoom

# Настройте мониторинг
cat /proc/meminfo  # Смотреть на MemAvailable, SwapFree
watch -n 1 "free -h"  # Автоматическое обновление
```

2. Настройка системы:

```bash
# Проверьте настройки OOM
sysctl vm.overcommit_memory
# 0 = ядро решает, 1 = всегда overcommit, 2 = не превышать RAM+Swap

# Настройте Swappiness (склонность к использованию swap)
sysctl vm.swappiness=10  # Меньше значения = реже использовать swap
```

3. Установите `EarlyOOM`:

```bash
# Утилита, которая срабатывает ДО полного исчерпания памяти
apt install earlyoom
systemctl enable --now earlyoom
```

EarlyOOM работает в userspace и убивает процессы раньше, чем система полностью зависнет.

4. Ограничение процессов через cgroups:

```bash
# Docker/контейнеры уже делают это
# Для обычных процессов можно настроить limits:
vim /etc/security/limits.conf
# Добавить: * hard rss 500000  # Ограничить память на пользователя
```

### **Что делать, если система уже зависла:**

1. **Попробуйте переключиться на консоль:** `Ctrl+Alt+F2` (F3, F4...)

2. **Если не помогает — SysRq:**

    - Сначала `Alt+SysRq+R` (вернуть управление клавиатурой)
    
    - Затем `Alt+SysRq+F` (вызвать OOM-killer)
    
    - Если не помогло — безопасная перезагрузка: **REISUB**

3. **Если SysRq не работает** (отключен в ядре) — только hard reset.

---
### **После восстановления:**

1. **Проверьте логи:**

```bash
dmesg | grep -i oom  # Сообщения от OOM-killer
dmesg | grep -i kill
journalctl -xb -p err  # Системные логи
grep -i oom /var/log/kern.log
```

2. Узнайте, какой процесс был убит:

```bash
# В логах будет что-то вроде:
# [ pid ]   uid  total_vm      rss nr_ptes swapents oom_score_adj name
# [12345]   1000   560011   153421     311    12560             0 bad_program
```

3. Примите меры:

    Настройте лимиты для проблемного приложения

    Напишите скрипт мониторинга

    Сообщите разработчикам о баге с утечкой памяти

    Рассмотрите увеличение RAM или оптимизацию

### **Критические сервера:**

1. **Настройте alert в мониторинге** (Zabbix, Prometheus) при использовании >90% памяти

2. **Используйте cgroups** для жесткого ограничения памяти критичных служб

3. **Регулярно тестируйте** процедуру восстановления

4. **Имейте резервный сервер** для критичных нагрузок

**Важно:** OOM — это не обычная ситуация, а **аварийная**. Современные системы должны иметь механизмы предотвращения (мониторинг, ограничения, earlyoom), а администраторы — чёткий план действий на случай её возникновения.