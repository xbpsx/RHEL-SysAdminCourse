**Оперативная память (ОЗУ)**** — это один из ключевых ресурсов, за которым системный администратор должен следить постоянно. Давайте разберем всё с практической точки зрения.

[[#1. Что такое оперативная память для системного администратора?]]
[[#2. Мониторинг оперативной памяти]]
[[#3. Анализ использования памяти процессами]]
[[#4. Управление памятью и оптимизация]]
[[#5. Swap (подкачка) — запасной аэродром]]
[[#6. Практические сценарии для системного администратора]]
[[#7. Инструменты для глубокого анализа]]
[[#8. Важные метрики, которые нужно отслеживать]]
[[#9. Автоматизация реагирования на проблемы]]
[[#Итог для системного администратора]]

---
## 1. Что такое оперативная память для системного администратора?

**Оперативная память** — это быстровременное хранилище данных, к которому процессор имеет мгновенный доступ. В отличие от дисков, ОЗУ:

- **Энергозависима** — данные исчезают при отключении питания

- **Очень быстрая** — в тысячи раз быстрее SSD

- **Ограниченный ресурс** — нельзя просто "добавить" без физического вмешательства

**Для сисадмина ОЗУ — это рабочее пространство системы**, где происходят все активные операции.

---
## 2. Мониторинг оперативной памяти

### Базовые команды мониторинга:

```bash
# Общая информация о памяти
free -h
```

![[Screenshot From 2025-11-26 15-32-25.png]]

**Что смотрим:**

- `available` — реально доступная память для новых процессов

- `buff/cache` — память, используемая для кэширования (может быть освобождена)

```bash
# Детальная информация
cat /proc/meminf

# В реальном времени
htop
top -o %MEM  # сортировка по использованию памяти
```

### Продвинутый мониторинг:

```bash
# Постоянный мониторинг с обновлением каждые 2 секунды
watch -n 2 'free -h; echo "---"; ps aux --sort=-%mem | head -10'

# Использование памяти по процессам
ps aux --sort=-%mem | head -10

# Статистика памяти за период
vmstat 5 10  # каждые 5 секунд, 10 раз
```

---
## 3. Анализ использования памяти процессами

### Поиск "прожорливых" процессов:

```bash
# Топ процессов по памяти
ps aux --sort=-%mem | head -10

# Альтернатива с htop
htop -s PERCENT_MEM

# Детальная информация о конкретном процессе
pmap -x $(pgrep nginx)  # для процесса nginx

# Использование памяти Java-процессами
jstat -gc $(pgrep java) 1000 5
```

### Сценарий для автоматического поиска:

```bash
#!/bin/bash
# find_memory_hogs.sh
echo "=== Top 10 memory consuming processes ==="
ps aux --sort=-%mem | head -11

echo -e "\n=== Processes using >500MB RSS ==="
ps aux | awk '{$6=$6/1024; if ($6 > 500) print $2, $11, $6 "MB"}'
```

---
## 4. Управление памятью и оптимизация

### Очистка кэша памяти (осторожно!):

```bash
# Просмотр того, что будет очищено
echo 1 | sudo tee /proc/sys/vm/drop_caches  # очистка pagecache
echo 2 | sudo tee /proc/sys/vm/drop_caches  # очистка dentries и inodes
echo 3 | sudo tee /proc/sys/vm/drop_caches  # очистка всего

# Более безопасный способ - через sync
sync && echo 3 | sudo tee /proc/sys/vm/drop_caches
```

### Настройка параметров ядра для памяти:

```bash
# Просмотр текущих настроек
sysctl -a | grep vm

# Временное изменение (до перезагрузки)
sudo sysctl -w vm.swappiness=10
sudo sysctl -w vm.vfs_cache_pressure=50

# Постоянное изменение
echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
echo "vm.vfs_cache_pressure=50" | sudo tee -a /etc/sysctl.conf
```

---
## 5. Swap (подкачка) — запасной аэродром

### Мониторинг swap:

```bash
# Общая информация
swapon --show
free -h

# Детали использования
cat /proc/swaps

# Статистика swap
vmstat -s | grep swap
```

### Управление swap:

```bash
# Временное отключение swap
sudo swapoff -a

# Включение swap
sudo swapon -a

# Добавление swap-файла (если нужно увеличить)
sudo dd if=/dev/zero of=/swapfile bs=1G count=2
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# Сделать постоянным
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

---
## 6. Практические сценарии для системного администратора

### Сценарий 1: Экстренная ситуация — нехватка памяти

```bash
#!/bin/bash
# emergency_memory_check.sh

MEM_THRESHOLD=90
CURRENT_USAGE=$(free | awk 'NR==2{printf "%.0f", $3/$2*100}')

if [ $CURRENT_USAGE -gt $MEM_THRESHOLD ]; then
    echo "CRITICAL: Memory usage at ${CURRENT_USAGE}%"
    echo "Top memory consumers:"
    ps aux --sort=-%mem | head -6
    
    # Автоматические действия
    echo "Cleaning page cache..."
    sync && echo 1 > /proc/sys/vm/drop_caches
    
    # Уведомление
    wall "Внимание: высокая загрузка памяти! Проведите диагностику."
fi
```

### Сценарий 2: Ежедневный отчет по памяти

```bash
#!/bin/bash
# daily_memory_report.sh

REPORT_FILE="/var/log/memory_report_$(date +%Y%m%d).log"

{
    echo "=== Memory Report $(date) ==="
    echo ""
    echo "--- Overall Memory Usage ---"
    free -h
    echo ""
    echo "--- Top 10 Memory Processes ---"
    ps aux --sort=-%mem | head -11
    echo ""
    echo "--- Memory Info ---"
    cat /proc/meminfo | grep -E "(MemTotal|MemFree|MemAvailable|SwapTotal|SwapFree)"
} > $REPORT_FILE
```

### Сценарий 3: Настройка сервисов под доступную память

```bash
#!/bin/bash
# optimize_services_memory.sh

TOTAL_MEM=$(free -m | awk 'NR==2{print $2}')

# Для MySQL
if [ $TOTAL_MEM -lt 1024 ]; then
    # Малопамятные настройки
    sudo sed -i 's/innodb_buffer_pool_size=.*/innodb_buffer_pool_size=256M/' /etc/mysql/my.cnf
else
    # Оптимальные настройки для сервера с большой памятью
    POOL_SIZE=$((TOTAL_MEM * 70 / 100))
    sudo sed -i "s/innodb_buffer_pool_size=.*/innodb_buffer_pool_size=${POOL_SIZE}M/" /etc/mysql/my.cnf
fi

# Перезапуск сервисов
sudo systemctl restart mysql
```

### Сценарий 4: Мониторинг утечек памяти

```bash
#!/bin/bash
# memory_leak_detector.sh

PROCESS="my_application"
LOG_FILE="/var/log/memory_leak.log"

while true; do
    MEM_USAGE=$(ps aux | grep $PROCESS | grep -v grep | awk '{print $6}')
    if [ ! -z "$MEM_USAGE" ]; then
        echo "$(date): $PROCESS using ${MEM_USAGE}KB" >> $LOG_FILE
        
        # Проверка на быстрый рост памяти
        if [ $MEM_USAGE -gt 1000000 ]; then  # более 1GB
            echo "WARNING: Possible memory leak detected!" >> $LOG_FILE
            # Действия при обнаружении утечки
        fi
    fi
    sleep 300  # проверка каждые 5 минут
done
```

---
## 7. Инструменты для глубокого анализа

### Установка полезных утилит:

```bash
# Для RHEL/CentOS/Fedora
sudo dnf install procps-ng htop atop smem

# Для Debian/Ubuntu
sudo apt install procps htop atop smem
```

### Использование smem для детального анализа:

```bash
# Установка
sudo dnf install smem

# Использование
smem -s rss -r      # сортировка по использованию RSS
smem -p -s swap -r  # использование swap процессами
smem -u             # по пользователям
```

---
## 8. Важные метрики, которые нужно отслеживать

```bash
# Критические метрики для мониторинга
- Потребление памяти ключевыми сервисами (БД, веб-серверы)
- Swap usage (должен быть минимальным)
- Page faults (vmstat 1)
- Memory pressure (cat /proc/pressure/memory)
- OOM killer активности (dmesg | grep oom)
```

---
## 9. Автоматизация реагирования на проблемы

### Настройка alert в cron:

```bash
# В crontab -e
# Проверка памяти каждые 5 минут
*/5 * * * * /home/admin/scripts/memory_check.sh

# Ежедневный отчет
0 9 * * * /home/admin/scripts/daily_memory_report.sh
```

---
## Итог для системного администратора

**Оперативная память — это "рабочий стол" вашей системы.** Сильный сисадмин:

1. **Постоянно мониторит** использование памяти

2. **Понимает разницу** между used, cached, available

3. **Знает процессы** которые обычно потребляют много памяти

4. **Настраивает сервисы** в соответствии с доступной памятью

5. **Имеет скрипты** для автоматического реагирования на проблемы

6. **Понимает когда** нужно увеличивать память физически

**Главное правило:** Лучше иметь запас памяти и не использовать его полностью, чем постоянно бороться с нехваткой. Память — дешевый ресурс по сравнению с простоями системы!