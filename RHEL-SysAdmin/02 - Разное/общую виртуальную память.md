## Что такое общая виртуальная память

### Простыми словами (Как для офиса):

Представьте **общую виртуальную память** как общий офис с белыми досками:

- **Каждый сотрудник (поток)** имеет:

    - Личный блокнот (стек потока) — только для себя

    - Доступ к общим белым доскам (общая память) — все видят изменения

- **Изменения на общей доске** видны всем сразу

- **Личные блокноты** — приватны для каждого

### Техническое определение:

**Общая виртуальная память** — это область памяти, которая доступна всем потокам одного процесса. Она включает:

- **Код программы** (text segment)

- **Глобальные переменные** (data segment)

- **Динамическая память** (heap)

- **Открытые файлы** (file descriptors)

### Для системного администратора:

#### Как это выглядит на практике:

```bash
# Просмотр памяти процесса и его потоков
pmap -x <PID>

# Или детальнее
cat /proc/<PID>/smaps
```

#### Пример с веб-сервером:

```bash
# У процесса Apache 100MB общей памяти
# И 10 потоков, каждый со своим стеком (по 8MB)
# Общее потребление: 100MB + (10 * 8MB) = 180MB
# Без потоков было бы: 10 процессов * 100MB = 1000MB
```

#### Практический мониторинг:

```bash
#!/bin/bash
# thread_memory_analysis.sh

PID=$1

echo "=== Анализ памяти процесса $PID и его потоков ==="

# Общая память процесса
echo "Общая память процесса:"
pmap -x $PID | tail -1

# Память отдельных потоков
echo -e "\nПамять потоков:"
for TID in $(ls /proc/$PID/task/); do
    if [ $TID -ne $PID ]; then
        MEM=$(pmap -x $TID 2>/dev/null | tail -1 | awk '{print $3}')
        if [ ! -z "$MEM" ]; then
            echo "Поток $TID: ${MEM}KB"
        fi
    fi
done
```

#### Проблемы и решения:

**Проблема**: Гонка данных (race conditions) — когда несколько потоков одновременно меняют общие данные  
**Решение для админа**: Мониторинг deadlock-ов и аномального поведения

```bash
# Поиск возможных deadlock-ов в логах
grep -i "deadlock\|lock.*timeout" /var/log/syslog

# Мониторинг блокировок
cat /proc/locks  # системные блокировки файлов
```


