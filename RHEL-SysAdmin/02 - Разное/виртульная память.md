## Что такое виртуальная память?

**Виртуальная память** — это абстракция, которая создает для каждой программы иллюзию, что она имеет в своем распоряжении непрерывное адресное пространство, изолированное от других программ, при этом это пространство может быть больше физической оперативной памяти.

### Простая аналогия:

Представьте, что у вас есть большой склад (физическая память) и много арендаторов (программ). Каждый арендатор получает "виртуальный склад" с собственной системой полок и ячеек. Он не знает, где физически хранятся его вещи — некоторые на основном складе, некоторые в удаленном хранилище (swap). Есть главный управляющий (ОС), который знает, где что лежит и подвозит нужные вещи по требованию.

---
## Как работает виртуальная память — технические детали


[[#1. Виртуальные адресные пространства]]
[[#2. Страничная организация памяти]]

[[#Практическое значение для системного администратора]]
[[#1. Мониторинг виртуальной памяти]]
[[#2. Анализ виртуальной памяти процессов]]
[[#3. Понимание различных типов памяти в процессах]]

[[#Реальные сценарии для системного администратора]]

[[#Инструменты для работы с виртуальной памятью]]

[[#Ключевые метрики, которые нужно отслеживать]]

[[#Практические примеры проблем и решений]]

[[#Итог для системного администратора]]

---
### 1. Виртуальные адресные пространства

Каждый процесс получает свое собственное 4GB (в 32-битных системах) или 128TB+ (в 64-битных) **виртуальное адресное пространство**.

```bash
# Посмотреть виртуальное адресное пространство процесса
pmap -x <PID>
cat /proc/<PID>/maps
```

### 2. Страничная организация памяти

Память делится на страницы (обычно 4KB):

- **Виртуальные страницы** — в адресном пространстве процесса

- **Физические фреймы** — в реальной оперативной памяти

- **Таблица страниц** — преобразует виртуальные адреса в физические

### 3. **Механизм подкачки (Swapping)**

Когда физической памяти не хватает, малоиспользуемые страницы перемещаются на диск.

---
## Практическое значение для системного администратора

### 1. Мониторинг виртуальной памяти

```bash
# Общая информация о виртуальной памяти
cat /proc/meminfo

# Ключевые метрики:
# - VmallocTotal: общий размер виртуального адресного пространства
# - VmallocUsed: использовано виртуальной памяти
# - PageTables: память, используемая для таблиц страниц

# Детальная статистика
vmstat -s
```

### 2. Анализ виртуальной памяти процессов

```bash
# Карта памяти процесса (очень полезно!)
pmap -x $(pgrep nginx)

# Пример вывода:
# Address           Kbytes     RSS   Dirty Mode  Mapping
# 000055f34d0f9000     892     792       0 r-x-- nginx    # код
# 000055f34d2c8000     204     144     144 rw--- nginx    # данные
# 00007f9b4e6c7000     132     132       0 r-x-- libc.so.6.1
# 00007f9b4e6e8000    2048       0       0 ----- libc.so.6.1
# 00007f9b4e8e8000      16      16      16 r---- libc.so.6.1
# 00007f9b4e8ec000       8       8       8 rw--- libc.so.6.1

# Суммарно по процессу
pmap -x $(pgrep nginx) | tail -1
# total kB          123456    78901    45678
```

### 3. Понимание различных типов памяти в процессах

```bash
# VSS (Virtual Set Size) - вся виртуальная память процесса
# RSS (Resident Set Size) - физическая память в ОЗУ
# PSS (Proportional Set Size) - RSS с учетом разделяемых библиотек
# USS (Unique Set Size) - уникальная память процесса

# Использование smem для детального анализа
smem -p -P nginx
```

---
## Реальные сценарии для системного администратора

### Сценарий 1: Диагностика утечек памяти

```bash
#!/bin/bash
# memory_leak_detector.sh

PROCESS=$1
PID=$(pgrep $PROCESS)

if [ -z "$PID" ]; then
    echo "Процесс $PROCESS не найден"
    exit 1
fi

echo "Мониторинг виртуальной памяти процесса $PROCESS (PID: $PID)"
echo "Время: $(date)"
echo ""

while true; do
    # Получаем статистику виртуальной памяти
    VIRT=$(ps -o vsz= -p $PID)
    RSS=$(ps -o rss= -p $PID)
    
    # Преобразуем в MB
    VIRT_MB=$((VIRT / 1024))
    RSS_MB=$((RSS / 1024))
    
    echo "$(date): VIRT=${VIRT_MB}MB RSS=${RSS_MB}MB"
    
    # Если виртуальная память растет, но RSS нет - возможна утечка
    if [ $VIRT_MB -gt 5000 ]; then  # больше 5GB
        echo "ПРЕДУПРЕЖДЕНИЕ: Высокое использование виртуальной памяти!"
        echo "Детальная карта памяти:"
        pmap -x $PID | tail -5
    fi
    
    sleep 60
done
```

### Сценарий 2: Анализ использования разделяемых библиотек

```bash
#!/bin/bash
# shared_memory_analysis.sh

# Какие библиотеки используются несколькими процессами
echo "=== Разделяемые библиотеки ==="
for lib in /usr/lib/*.so /lib/*.so; do
    COUNT=$(lsof "$lib" 2>/dev/null | wc -l)
    if [ $COUNT -gt 3 ]; then
        echo "$COUNT процессов используют: $(basename $lib)"
    fi
done

# Анализ PSS для понимания реального использования памяти
echo -e "\n=== Реальное использование памяти процессами (PSS) ==="
smem -s pss -r | head -10
```

### Сценарий 3: Настройка параметров виртуальной памяти

```bash
#!/bin/bash
# tune_virtual_memory.sh

# Текущие настройки
echo "=== Текущие настройки виртуальной памяти ==="
sysctl -a | grep vm | grep -E "(swappiness|dirty_ratio|vfs_cache_pressure)"

# Оптимизация для сервера с большим количеством процессов
echo "Оптимизация для сервера БД или веб-сервера..."

# Уменьшаем swappiness - меньше использовать swap
sudo sysctl -w vm.swappiness=10

# Увеличиваем dirty_ratio - больше буферизации перед записью на диск
sudo sysctl -w vm.dirty_ratio=40
sudo sysctl -w vm.dirty_background_ratio=10

# Уменьшаем vfs_cache_pressure - дольше держать кэш файловой системы
sudo sysctl -w vm.vfs_cache_pressure=50

# Сохраняем настройки
cat > /tmp/vm_tuning.conf << EOF
vm.swappiness=10
vm.dirty_ratio=40
vm.dirty_background_ratio=10
vm.vfs_cache_pressure=50
EOF

sudo cp /tmp/vm_tuning.conf /etc/sysctl.d/99-vm-tuning.conf
```

### Сценарий 4: Мониторинг page faults

```bash
#!/bin/bash
# monitor_page_faults.sh

# Page faults - обращение к отсутствующим страницам в памяти
echo "=== Мониторинг page faults ==="

while true; do
    MINOR_FAULTS=$(vmstat 1 2 | tail -1 | awk '{print $10}')
    MAJOR_FAULTS=$(vmstat 1 2 | tail -1 | awk '{print $11}')
    
    echo "$(date): Minor faults=$MINOR_FAULTS, Major faults=$MAJOR_FAULTS"
    
    # Major faults требуют чтения с диска - это медленно!
    if [ $MAJOR_FAULTS -gt 100 ]; then
        echo "ВНИМАНИЕ: Высокий уровень major page faults!"
        echo "Процессы с наибольшим количеством page faults:"
        ps -eo pid,comm,min_flt,maj_flt --sort=-maj_flt | head -10
    fi
    
    sleep 30
done
```

---
## Инструменты для работы с виртуальной памятью

### 1. **Основные команды:**

```bash
# Просмотр карты памяти процесса
pmap -x <PID>

# Детальная информация о памяти процесса
cat /proc/<PID>/smaps

# Статистика использования памяти
cat /proc/<PID>/statm  # показывает страницы

# Информация о системной памяти
cat /proc/meminfo
```

### 2. **Продвинутые инструменты:**

```bash
# Установка дополнительных утилит
sudo dnf install procps-ng htop numactl

# Анализ NUMA (для многопроцессорных систем)
numastat
numactl --hardware

# Профилирование памяти
valgrind --tool=massif ./your_program
```

---
## Ключевые метрики, которые нужно отслеживать

```bash
# В /proc/meminfo
- Committed_AS:    сколько виртуальной памяти выделено
- VmallocTotal:    всего виртуальной памяти
- VmallocUsed:     использовано виртуальной памяти
- PageTables:      память для таблиц страниц

# В процессах
- VIRT: вся виртуальная память процесса
- RSS:  физическая память в ОЗУ
- SHR:  разделяемая память
- %MEM: процент физической памяти
```

---
## Практические примеры проблем и решений

### Проблема: Процесс использует много VIRT, но мало RSS

**Решение:** Это нормально — процесс резервирует виртуальную память, но не использует ее физически.

### Проблема: Высокий уровень major page faults

**Решение:** Увеличить оперативную память или оптимизировать доступ к данным.

### Проблема: Большой размер PageTables

**Решение:** У процессов слишком фрагментирована память, возможно нужно перезапустить сервис.

---
## Итог для системного администратора

**Виртуальная память — это не просто абстракция, а рабочий инструмент.** Сильный админ:

1. **Понимает разницу** между VIRT, RSS, PSS, USS

2. **Умеет анализировать** карты памяти процессов с помощью `pmap`

3. **Мониторит page faults** как индикатор проблем с производительностью

4. **Настраивает параметры** виртуальной памяти под конкретную нагрузку

5. **Диагностирует утечки** памяти через анализ patterns использования VIRT/RSS

**Главное:** Виртуальная память позволяет системе работать с программами, которым "кажется", что у них есть гигабайты памяти, даже когда физической памяти мало. Это мощный механизм, но требующий грамотного управления со стороны администратора.